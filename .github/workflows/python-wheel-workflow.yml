
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: Build Python Wheels

on:
  pull_request:
    paths:
      - "**"
      - "cpp/**"
      - ".github/workflows/python-wheel-workflow.yml"
  push:
    branches:
      - "**"
    tags:
      - "python-v*"
      - "v*"
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to PyPI via Trusted Publishing (OIDC)"
        type: choice
        required: true
        default: "no"
        options:
          - "no"
          - "testpypi"
          - "pypi"

permissions:
  contents: read

jobs:
  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure LICENSE/NOTICE for Python package
        working-directory: python
        run: |
          cp -f ../LICENSE ./LICENSE
          cp -f ../NOTICE ./NOTICE

      - name: Vendor C++ sources into sdist
        run: |
          rm -rf python/cpp
          mkdir -p python/cpp
          rsync -a --delete \
            --exclude 'build*/' \
            --exclude '.git*/' \
            cpp/ python/cpp/

      - name: Build sdist
        working-directory: python
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: python-sdist
          path: python/dist/*.tar.gz

  wheels:
    name: Build wheels (${{ matrix.os }} / ${{ matrix.platform }})
    needs: sdist
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: x86_64
            runner: ubuntu-latest
            os: linux
            manylinux: "2_34"

          - platform: aarch64
            runner: ubuntu-latest
            os: linux
            manylinux: "2_34"

          - platform: x86_64
            runner: macos-15-intel
            os: macos
            deployment_target: "11.0"

          - platform: arm64
            runner: macos-latest
            os: macos
            deployment_target: "11.0"

          - platform: amd64
            runner: windows-2022
            os: windows

    env:
      CIBW_PLATFORM: ${{ matrix.os }}
      CIBW_ARCHS_LINUX: ${{ matrix.os == 'linux' && matrix.platform || '' }}
      CIBW_BUILD: "cp39-* cp310-* cp311-* cp312-* cp313-*"
      CIBW_SKIP: "pp* *-musllinux_*"
      CIBW_BUILD_VERBOSITY: "1"
      CIBW_REPAIR_WHEEL_COMMAND_LINUX: "python -m pip install -U auditwheel && auditwheel -v show {wheel} && auditwheel -v repair -w {dest_dir} {wheel}"
      CIBW_MANYLINUX_X86_64_IMAGE: ${{ matrix.os == 'linux' && format('manylinux_{0}', matrix.manylinux) || '' }}
      CIBW_MANYLINUX_AARCH64_IMAGE: ${{ matrix.os == 'linux' && format('manylinux_{0}', matrix.manylinux) || '' }}
      CIBW_ENVIRONMENT_LINUX: "CMAKE_PREFIX_PATH=/opt/conda LD_LIBRARY_PATH=/opt/conda/lib:$LD_LIBRARY_PATH"
      CIBW_ENVIRONMENT_MACOS: ${{ matrix.os == 'macos' && format('MACOSX_DEPLOYMENT_TARGET={0}', matrix.deployment_target) || '' }}

      # Install Arrow C++ once per job, then point CMake to it.
      CIBW_BEFORE_ALL_LINUX: |
        set -eux
        arch="$(uname -m)"
        case "${arch}" in
          x86_64) mm_plat="linux-64" ;;
          aarch64|arm64) mm_plat="linux-aarch64" ;;
          *) echo "Unsupported arch: ${arch}"; exit 1 ;;
        esac
        curl -Ls "https://micro.mamba.pm/api/micromamba/${mm_plat}/latest" | tar -xvj bin/micromamba
        chmod +x bin/micromamba
        ./bin/micromamba create -y -p /opt/conda -c conda-forge \
          arrow-cpp=14 \
          cmake \
          ninja \
          pkg-config
      CIBW_BEFORE_ALL_MACOS: |
        set -eux
        brew install apache-arrow

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU (Linux aarch64)
        if: matrix.os == 'linux' && matrix.platform == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: python-sdist
          path: python/dist

      - name: Set SDIST_FILE
        shell: bash
        run: echo "SDIST_FILE=$(ls python/dist/*.tar.gz | head -n 1)" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install cibuildwheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel

      - name: Setup conda (Windows)
        if: matrix.os == 'windows'
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          miniforge-variant: Miniforge3
          miniforge-version: latest
          use-mamba: true
          channels: conda-forge
          python-version: "3.11"
          auto-activate-base: false
          activate-environment: cibw

      - name: Install Arrow C++ (Windows)
        if: matrix.os == 'windows'
        shell: powershell
        run: |
          mamba install -y arrow-cpp cmake ninja
          "CIBW_ENVIRONMENT_WINDOWS=CMAKE_PREFIX_PATH=$env:CONDA_PREFIX\\Library" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Set CMAKE_PREFIX_PATH (macOS)
        if: matrix.os == 'macos'
        shell: bash
        run: |
          echo "CIBW_ENVIRONMENT_MACOS=${CIBW_ENVIRONMENT_MACOS} CMAKE_PREFIX_PATH=$(brew --prefix)" >> $GITHUB_ENV

      - name: Build wheels
        shell: bash
        run: |
          python -m cibuildwheel "$SDIST_FILE" --output-dir python/wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.platform }}
          path: python/wheelhouse/*.whl

  publish:
    name: Publish to PyPI
    needs: [sdist, wheels]
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish != 'no')
    permissions:
      contents: read
      id-token: write
    environment: ${{ (github.event_name == 'push' && 'pypi') || inputs.publish }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Sanity check (twine)
        run: |
          python -m pip install --upgrade pip
          python -m pip install twine
          twine check dist/*

      - name: Publish to PyPI (tag)
        if: github.event_name == 'push'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

      - name: Publish to TestPyPI (manual)
        if: github.event_name == 'workflow_dispatch' && inputs.publish == 'testpypi'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          repository-url: https://test.pypi.org/legacy/

      - name: Publish to PyPI (manual)
        if: github.event_name == 'workflow_dispatch' && inputs.publish == 'pypi'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
